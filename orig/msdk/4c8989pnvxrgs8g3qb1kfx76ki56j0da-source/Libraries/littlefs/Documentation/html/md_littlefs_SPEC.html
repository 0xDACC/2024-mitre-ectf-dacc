<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>MAX3267X LittleFS demo: littlefs technical specification</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MAX3267X LittleFS demo
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_littlefs_SPEC.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">littlefs technical specification </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the technical specification of the little filesystem. This document covers the technical details of how the littlefs is stored on disk for introspection and tooling. This document assumes you are familiar with the design of the littlefs, for more info on how littlefs works check out <a class="el" href="_d_e_s_i_g_n_8md.html">DESIGN.md</a>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;   | | |     .---._____</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  .-----.   |          |</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;--|o    |---| littlefs |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;--|     |---|          |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  &#39;-----&#39;   &#39;----------&#39;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;   | | |</div></div><!-- fragment --><h2>Some quick notes</h2>
<ul>
<li>littlefs is a block-based filesystem. The disk is divided into an array of evenly sized blocks that are used as the logical unit of storage.</li>
<li>Block pointers are stored in 32 bits, with the special value <code>0xffffffff</code> representing a null block address.</li>
<li>In addition to the logical block size (which usually matches the erase block size), littlefs also uses a program block size and read block size. These determine the alignment of block device operations, but don't need to be consistent for portability.</li>
<li>By default, all values in littlefs are stored in little-endian byte order.</li>
</ul>
<h2>Directories / Metadata pairs</h2>
<p>Metadata pairs form the backbone of littlefs and provide a system for distributed atomic updates. Even the superblock is stored in a metadata pair.</p>
<p>As their name suggests, a metadata pair is stored in two blocks, with one block providing a backup during erase cycles in case power is lost. These two blocks are not necessarily sequential and may be anywhere on disk, so a "pointer" to a metadata pair is stored as two block pointers.</p>
<p>On top of this, each metadata block behaves as an appendable log, containing a variable number of commits. Commits can be appended to the metadata log in order to update the metadata without requiring an erase cycles. Note that successive commits may supersede the metadata in previous commits. Only the most recent metadata should be considered valid.</p>
<p>The high-level layout of a metadata block is fairly simple:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;  .---------------------------------------.</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;.-|  revision count   |      entries      |  \</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;| |-------------------+                   |  |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;| |                                       |  |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;| |                                       |  +-- 1st commit</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;| |                                       |  |</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;| |                   +-------------------|  |</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;| |                   |        CRC        |  /</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;| |-------------------+-------------------|</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;| |                entries                |  \</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;| |                                       |  |</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;| |                                       |  +-- 2nd commit</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;| |    +-------------------+--------------|  |</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;| |    |        CRC        |    padding   |  /</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;| |----+-------------------+--------------|</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;| |                entries                |  \</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;| |                                       |  |</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;| |                                       |  +-- 3rd commit</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;| |         +-------------------+---------|  |</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;| |         |        CRC        |         |  /</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;| |---------+-------------------+         |</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;| |           unwritten storage           |  more commits</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;| |                                       |       |</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;| |                                       |       v</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;| |                                       |</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;| |                                       |</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;| &#39;---------------------------------------&#39;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;&#39;---------------------------------------&#39;</div></div><!-- fragment --><p>Each metadata block contains a 32-bit revision count followed by a number of commits. Each commit contains a variable number of metadata entries followed by a 32-bit CRC.</p>
<p>Note also that entries aren't necessarily word-aligned. This allows us to store metadata more compactly, however we can only write to addresses that are aligned to our program block size. This means each commit may have padding for alignment.</p>
<p>Metadata block fields:</p>
<ol type="1">
<li><b>Revision count (32-bits)</b> - Incremented every erase cycle. If both blocks contain valid commits, only the block with the most recent revision count should be used. Sequence comparison must be used to avoid issues with integer overflow.</li>
<li><b>CRC (32-bits)</b> - Detects corruption from power-loss or other write issues. Uses a CRC-32 with a polynomial of <code>0x04c11db7</code> initialized with <code>0xffffffff</code>.</li>
</ol>
<p>Entries themselves are stored as a 32-bit tag followed by a variable length blob of data. But exactly how these tags are stored is a little bit tricky.</p>
<p>Metadata blocks support both forward and backward iteration. In order to do this without duplicating the space for each tag, neighboring entries have their tags XORed together, starting with <code>0xffffffff</code>.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; Forward iteration                        Backward iteration</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;.-------------------.  0xffffffff        .-------------------.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;|  revision count   |      |             |  revision count   |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;|-------------------|      v             |-------------------|</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;|      tag ~A       |---&gt; xor -&gt; tag A   |      tag ~A       |---&gt; xor -&gt; 0xffffffff</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;|-------------------|      |             |-------------------|      ^</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;|       data A      |      |             |       data A      |      |</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;|                   |      |             |                   |      |</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;|                   |      |             |                   |      |</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;|-------------------|      v             |-------------------|      |</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;|      tag AxB      |---&gt; xor -&gt; tag B   |      tag AxB      |---&gt; xor -&gt; tag A</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;|-------------------|      |             |-------------------|      ^</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;|       data B      |      |             |       data B      |      |</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;|                   |      |             |                   |      |</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;|                   |      |             |                   |      |</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;|-------------------|      v             |-------------------|      |</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;|      tag BxC      |---&gt; xor -&gt; tag C   |      tag BxC      |---&gt; xor -&gt; tag B</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;|-------------------|                    |-------------------|      ^</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;|       data C      |                    |       data C      |      |</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;|                   |                    |                   |    tag C</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;|                   |                    |                   |</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;|                   |                    |                   |</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;&#39;-------------------&#39;                    &#39;-------------------&#39;</div></div><!-- fragment --><p>One last thing to note before we get into the details around tag encoding. Each tag contains a valid bit used to indicate if the tag and containing commit is valid. This valid bit is the first bit found in the tag and the commit and can be used to tell if we've attempted to write to the remaining space in the block.</p>
<p>Here's a more complete example of metadata block containing 4 entries:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;  .---------------------------------------.</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;.-|  revision count   |      tag ~A       |        \</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;| |-------------------+-------------------|        |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;| |                 data A                |        |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;| |                                       |        |</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;| |-------------------+-------------------|        |</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;| |      tag AxB      |       data B      | &lt;--.   |</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;| |-------------------+                   |    |   |</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;| |                                       |    |   +-- 1st commit</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;| |         +-------------------+---------|    |   |</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;| |         |      tag BxC      |         | &lt;-.|   |</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;| |---------+-------------------+         |   ||   |</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;| |                 data C                |   ||   |</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;| |                                       |   ||   |</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;| |-------------------+-------------------|   ||   |</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;| |     tag CxCRC     |        CRC        |   ||   /</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;| |-------------------+-------------------|   ||</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;| |     tag CRCxA&#39;    |      data A&#39;      |   ||   \</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;| |-------------------+                   |   ||   |</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;| |                                       |   ||   |</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;| |              +-------------------+----|   ||   +-- 2nd commit</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;| |              |     tag CRCxA&#39;    |    |   ||   |</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;| |--------------+-------------------+----|   ||   |</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;| | CRC          |        padding         |   ||   /</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;| |--------------+----+-------------------|   ||</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;| |     tag CRCxA&#39;&#39;   |      data A&#39;&#39;     | &lt;---.  \</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;| |-------------------+                   |   |||  |</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;| |                                       |   |||  |</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;| |         +-------------------+---------|   |||  |</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;| |         |     tag A&#39;&#39;xD     |         | &lt; |||  |</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;| |---------+-------------------+         |  ||||  +-- 3rd commit</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;| |                data D                 |  ||||  |</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;| |                             +---------|  ||||  |</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;| |                             |   tag Dx|  ||||  |</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;| |---------+-------------------+---------|  ||||  |</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;| |CRC      |        CRC        |         |  ||||  /</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;| |---------+-------------------+         |  ||||</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;| |           unwritten storage           |  ||||  more commits</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;| |                                       |  ||||       |</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;| |                                       |  ||||       v</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;| |                                       |  ||||</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;| |                                       |  ||||</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;| &#39;---------------------------------------&#39;  ||||</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;&#39;---------------------------------------&#39;    |||&#39;- most recent A</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                                             ||&#39;-- most recent B</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                                             |&#39;--- most recent C</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                                             &#39;---- most recent D</div></div><!-- fragment --><h2>Metadata tags</h2>
<p>So in littlefs, 32-bit tags describe every type of metadata. And this means <em>every</em> type of metadata, including file entries, directory fields, and global state. Even the CRCs used to mark the end of commits get their own tag.</p>
<p>Because of this, the tag format contains some densely packed information. Note that there are multiple levels of types which break down into more info:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[----            32             ----]</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[1|--  11   --|--  10  --|--  10  --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; ^.     ^     .     ^          ^- length</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; |.     |     .     &#39;------------ id</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |.     &#39;-----.------------------ type (type3)</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; &#39;.-----------.------------------ valid bit</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  [-3-|-- 8 --]</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    ^     ^- chunk</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    &#39;------- type (type1)</div></div><!-- fragment --><p>Before we go further, there's one important thing to note. These tags are <b>not</b> stored in little-endian. Tags stored in commits are actually stored in big-endian (and is the only thing in littlefs stored in big-endian). This little bit of craziness comes from the fact that the valid bit must be the first bit in a commit, and when converted to little-endian, the valid bit finds itself in byte 4. We could restructure the tag to store the valid bit lower, but, because none of the fields are byte-aligned, this would be more complicated than just storing the tag in big-endian.</p>
<p>Another thing to note is that both the tags <code>0x00000000</code> and <code>0xffffffff</code> are invalid and can be used for null values.</p>
<p>Metadata tag fields:</p>
<ol type="1">
<li><b>Valid bit (1-bit)</b> - Indicates if the tag is valid.</li>
<li><b>Type3 (11-bits)</b> - Type of the tag. This field is broken down further into a 3-bit abstract type and an 8-bit chunk field. Note that the value <code>0x000</code> is invalid and not assigned a type.</li>
<li><b>Type1 (3-bits)</b> - Abstract type of the tag. Groups the tags into 8 categories that facilitate bitmasked lookups.</li>
<li><b>Chunk (8-bits)</b> - Chunk field used for various purposes by the different abstract types. type1+chunk+id form a unique identifier for each tag in the metadata block.</li>
<li><b>Id (10-bits)</b> - File id associated with the tag. Each file in a metadata block gets a unique id which is used to associate tags with that file. The special value <code>0x3ff</code> is used for any tags that are not associated with a file, such as directory and global metadata.</li>
<li><b>Length (10-bits)</b> - Length of the data in bytes. The special value <code>0x3ff</code> indicates that this tag has been deleted.</li>
</ol>
<h2>Metadata types</h2>
<p>What follows is an exhaustive list of metadata in littlefs. </p><hr/>
 <h4><code>0x401</code> LFS_TYPE_CREATE</h4>
<p>Creates a new file with this id. Note that files in a metadata block don't necessarily need a create tag. All a create does is move over any files using this id. In this sense a create is similar to insertion into an imaginary array of files.</p>
<p>The create and delete tags allow littlefs to keep files in a directory ordered alphabetically by filename. </p><hr/>
 <h4><code>0x4ff</code> LFS_TYPE_DELETE</h4>
<p>Deletes the file with this id. An inverse to create, this tag moves over any files neighboring this id similar to a deletion from an imaginary array of files. </p><hr/>
 <h4><code>0x0xx</code> LFS_TYPE_NAME</h4>
<p>Associates the id with a file name and file type.</p>
<p>The data contains the file name stored as an ASCII string (may be expanded to UTF8 in the future).</p>
<p>The chunk field in this tag indicates an 8-bit file type which can be one of the following.</p>
<p>Currently, the name tag must precede any other tags associated with the id and can not be reassigned without deleting the file.</p>
<p>Layout of the name tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][---        variable length        ---]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1| 3| 8 | 10 | 10 ][---          (size * 8)           ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^  ^  ^    ^    ^- size                   ^- file name</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |  |  |    &#39;------ id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |  |  &#39;----------- file type</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |  &#39;-------------- type1 (0x0)</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>Name fields:</p>
<ol type="1">
<li><b>file type (8-bits)</b> - Type of the file.</li>
<li><b>file name</b> - File name stored as an ASCII string. <hr/>
 <h4><code>0x001</code> LFS_TYPE_REG</h4>
</li>
</ol>
<p>Initializes the id + name as a regular file.</p>
<p>How each file is stored depends on its struct tag, which is described below. </p><hr/>
 <h4><code>0x002</code> LFS_TYPE_DIR</h4>
<p>Initializes the id + name as a directory.</p>
<p>Directories in littlefs are stored on disk as a linked-list of metadata pairs, each pair containing any number of files in alphabetical order. A pointer to the directory is stored in the struct tag, which is described below. </p><hr/>
 <h4><code>0x0ff</code> LFS_TYPE_SUPERBLOCK</h4>
<p>Initializes the id as a superblock entry.</p>
<p>The superblock entry is a special entry used to store format-time configuration and identify the filesystem.</p>
<p>The name is a bit of a misnomer. While the superblock entry serves the same purpose as a superblock found in other filesystems, in littlefs the superblock does not get a dedicated block. Instead, the superblock entry is duplicated across a linked-list of metadata pairs rooted on the blocks 0 and 1. The last metadata pair doubles as the root directory of the filesystem.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; .--------.  .--------.  .--------.  .--------.  .--------.</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;.| super  |-&gt;| super  |-&gt;| super  |-&gt;| super  |-&gt;| file B |</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;|| block  | || block  | || block  | || block  | || file C |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;||        | ||        | ||        | || file A | || file D |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;|&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;&#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;\----------------+----------------/ \----------+----------/</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;          superblock pairs               root directory</div></div><!-- fragment --><p>The filesystem starts with only the root directory. The superblock metadata pairs grow every time the root pair is compacted in order to prolong the life of the device exponentially.</p>
<p>The contents of the superblock entry are stored in a name tag with the superblock type and an inline-struct tag. The name tag contains the magic string "littlefs", while the inline-struct tag contains version and configuration information.</p>
<p>Layout of the superblock name tag and inline-struct tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|--      32      --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1|- 11 -| 10 | 10 ][---              64               ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^    ^     ^    ^- size (8)           ^- magic string (&quot;littlefs&quot;)</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |    |     &#39;------ id (0)</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |    &#39;------------ type (0x0ff)</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; &#39;----------------- valid bit</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        tag                          data</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;[--      32      --][--      32      --|--      32      --|--      32      --]</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;[1|- 11 -| 10 | 10 ][--      32      --|--      32      --|--      32      --]</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160; ^    ^     ^    ^            ^- version         ^- block size      ^- block count</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; |    |     |    |  [--      32      --|--      32      --|--      32      --]</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; |    |     |    |  [--      32      --|--      32      --|--      32      --]</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; |    |     |    |            ^- name max        ^- file max        ^- attr max</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; |    |     |    &#39;- size (24)</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; |    |     &#39;------ id (0)</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160; |    &#39;------------ type (0x201)</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>Superblock fields:</p>
<ol type="1">
<li><b>Magic string (8-bytes)</b> - Magic string indicating the presence of littlefs on the device. Must be the string "littlefs".</li>
<li><p class="startli"><b>Version (32-bits)</b> - The version of littlefs at format time. The version is encoded in a 32-bit value with the upper 16-bits containing the major version, and the lower 16-bits containing the minor version.</p>
<p class="startli">This specification describes version 2.0 (<code>0x00020000</code>).</p>
</li>
<li><b>Block size (32-bits)</b> - Size of the logical block size used by the filesystem in bytes.</li>
<li><b>Block count (32-bits)</b> - Number of blocks in the filesystem.</li>
<li><b>Name max (32-bits)</b> - Maximum size of file names in bytes.</li>
<li><b>File max (32-bits)</b> - Maximum size of files in bytes.</li>
<li><b>Attr max (32-bits)</b> - Maximum size of file attributes in bytes.</li>
</ol>
<p>The superblock must always be the first entry (id 0) in a metadata pair as well as be the first entry written to the block. This means that the superblock entry can be read from a device using offsets alone. </p><hr/>
 <h4><code>0x2xx</code> LFS_TYPE_STRUCT</h4>
<p>Associates the id with an on-disk data structure.</p>
<p>The exact layout of the data depends on the data structure type stored in the chunk field and can be one of the following.</p>
<p>Any type of struct supersedes all other structs associated with the id. For example, appending a ctz-struct replaces an inline-struct on the same file. </p><hr/>
 <h4><code>0x200</code> LFS_TYPE_DIRSTRUCT</h4>
<p>Gives the id a directory data structure.</p>
<p>Directories in littlefs are stored on disk as a linked-list of metadata pairs, each pair containing any number of files in alphabetical order.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;     |</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;     v</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; .--------.  .--------.  .--------.  .--------.  .--------.  .--------.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;.| file A |-&gt;| file D |-&gt;| file G |-&gt;| file I |-&gt;| file J |-&gt;| file M |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;|| file B | || file E | || file H | ||        | || file K | || file N |</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;|| file C | || file F | ||        | ||        | || file L | ||        |</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;|&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;&#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;</div></div><!-- fragment --><p>The dir-struct tag contains only the pointer to the first metadata-pair in the directory. The directory size is not known without traversing the directory.</p>
<p>The pointer to the next metadata-pair in the directory is stored in a tail tag, which is described below.</p>
<p>Layout of the dir-struct tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|--      32      --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1|- 11 -| 10 | 10 ][---              64               ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^    ^     ^    ^- size (8)           ^- metadata pair</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |    |     &#39;------ id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |    &#39;------------ type (0x200)</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>Dir-struct fields:</p>
<ol type="1">
<li><b>Metadata pair (8-bytes)</b> - Pointer to the first metadata-pair in the directory. <hr/>
 <h4><code>0x201</code> LFS_TYPE_INLINESTRUCT</h4>
</li>
</ol>
<p>Gives the id an inline data structure.</p>
<p>Inline structs store small files that can fit in the metadata pair. In this case, the file data is stored directly in the tag's data area.</p>
<p>Layout of the inline-struct tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][---        variable length        ---]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1|- 11 -| 10 | 10 ][---           (size * 8)          ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^    ^     ^    ^- size                    ^- inline data</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |    |     &#39;------ id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |    &#39;------------ type (0x201)</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>Inline-struct fields:</p>
<ol type="1">
<li><b>Inline data</b> - File data stored directly in the metadata-pair. <hr/>
 <h4><code>0x202</code> LFS_TYPE_CTZSTRUCT</h4>
</li>
</ol>
<p>Gives the id a CTZ skip-list data structure.</p>
<p>CTZ skip-lists store files that can not fit in the metadata pair. These files are stored in a skip-list in reverse, with a pointer to the head of the skip-list. Note that the head of the skip-list and the file size is enough information to read the file.</p>
<p>How exactly CTZ skip-lists work is a bit complicated. A full explanation can be found in the <a href="DESIGN.md#ctz-skip-lists">DESIGN.md</a>.</p>
<p>A quick summary: For every <em>n</em>&zwj;th block where <em>n</em> is divisible by 2&zwj;_&amp;#739;_, that block contains a pointer to block <em>n</em>-2&zwj;_&amp;#739;_. These pointers are stored in increasing order of <em>x</em> in each block of the file before the actual data.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;                                                               |</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;                                                               v</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;.--------.  .--------.  .--------.  .--------.  .--------.  .--------.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;| A      |&lt;-| D      |&lt;-| G      |&lt;-| J      |&lt;-| M      |&lt;-| P      |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;| B      |&lt;-| E      |--| H      |&lt;-| K      |--| N      |  | Q      |</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;| C      |&lt;-| F      |--| I      |--| L      |--| O      |  |        |</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;&#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  block 0     block 1     block 2     block 3     block 4     block 5</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;              1 skip      2 skips     1 skip      3 skips     1 skip</div></div><!-- fragment --><p>Note that the maximum number of pointers in a block is bounded by the maximum file size divided by the block size. With 32 bits for file size, this results in a minimum block size of 104 bytes.</p>
<p>Layout of the CTZ-struct tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|--      32      --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1|- 11 -| 10 | 10 ][--      32      --|--      32      --]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^    ^     ^    ^            ^                  ^- file size</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |    |     |    |            &#39;-------------------- file head</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |    |     |    &#39;- size (8)</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |    |     &#39;------ id</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; |    &#39;------------ type (0x202)</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>CTZ-struct fields:</p>
<ol type="1">
<li><b>File head (32-bits)</b> - Pointer to the block that is the head of the file's CTZ skip-list.</li>
<li><b>File size (32-bits)</b> - Size of the file in bytes. <hr/>
 <h4><code>0x3xx</code> LFS_TYPE_USERATTR</h4>
</li>
</ol>
<p>Attaches a user attribute to an id.</p>
<p>littlefs has a concept of "user attributes". These are small user-provided attributes that can be used to store things like timestamps, hashes, permissions, etc.</p>
<p>Each user attribute is uniquely identified by an 8-bit type which is stored in the chunk field, and the user attribute itself can be found in the tag's data.</p>
<p>There are currently no standard user attributes and a portable littlefs implementation should work with any user attributes missing.</p>
<p>Layout of the user-attr tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][---        variable length        ---]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1| 3| 8 | 10 | 10 ][---           (size * 8)          ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^  ^  ^    ^    ^- size                    ^- attr data</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |  |  |    &#39;------ id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |  |  &#39;----------- attr type</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |  &#39;-------------- type1 (0x3)</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>User-attr fields:</p>
<ol type="1">
<li><b>Attr type (8-bits)</b> - Type of the user attributes.</li>
<li><b>Attr data</b> - The data associated with the user attribute. <hr/>
 <h4><code>0x6xx</code> LFS_TYPE_TAIL</h4>
</li>
</ol>
<p>Provides the tail pointer for the metadata pair itself.</p>
<p>The metadata pair's tail pointer is used in littlefs for a linked-list containing all metadata pairs. The chunk field contains the type of the tail, which indicates if the following metadata pair is a part of the directory (hard-tail) or only used to traverse the filesystem (soft-tail).</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;         .--------.</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;        .| dir A  |-.</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;        ||softtail| |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;.--------|        |-&#39;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;|       |&#39;--------&#39;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;|       &#39;---|--|-&#39;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;|        .-&#39;    &#39;-------------.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;|       v                      v</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;|  .--------.  .--------.  .--------.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;&#39;-&gt;| dir B  |-&gt;| dir B  |-&gt;| dir C  |</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  ||hardtail| ||softtail| ||        |</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  ||        | ||        | ||        |</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;  &#39;--------&#39;  &#39;--------&#39;  &#39;--------&#39;</div></div><!-- fragment --><p>Currently any type supersedes any other preceding tails in the metadata pair, but this may change if additional metadata pair state is added.</p>
<p>A note about the metadata pair linked-list: Normally, this linked-list contains every metadata pair in the filesystem. However, there are some operations that can cause this linked-list to become out of sync if a power-loss were to occur. When this happens, littlefs sets the "sync" flag in the global state. How exactly this flag is stored is described below.</p>
<p>When the sync flag is set:</p>
<ol type="1">
<li>The linked-list may contain an orphaned directory that has been removed in the filesystem.</li>
<li>The linked-list may contain a metadata pair with a bad block that has been replaced in the filesystem.</li>
</ol>
<p>If the sync flag is set, the threaded linked-list must be checked for these errors before it can be used reliably. Note that the threaded linked-list can be ignored if littlefs is mounted read-only.</p>
<p>Layout of the tail tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                          data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|--      32      --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1| 3| 8 | 10 | 10 ][---              64               ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^  ^  ^   ^    ^- size (8)            ^- metadata pair</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |  |  |   &#39;------ id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |  |  &#39;---------- tail type</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |  &#39;------------- type1 (0x6)</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; &#39;---------------- valid bit</div></div><!-- fragment --><p>Tail fields:</p>
<ol type="1">
<li><b>Tail type (8-bits)</b> - Type of the tail pointer.</li>
<li><b>Metadata pair (8-bytes)</b> - Pointer to the next metadata-pair. <hr/>
 <h4><code>0x600</code> LFS_TYPE_SOFTTAIL</h4>
</li>
</ol>
<p>Provides a tail pointer that points to the next metadata pair in the filesystem.</p>
<p>In this case, the next metadata pair is not a part of our current directory and should only be followed when traversing the entire filesystem. </p><hr/>
 <h4><code>0x601</code> LFS_TYPE_HARDTAIL</h4>
<p>Provides a tail pointer that points to the next metadata pair in the directory.</p>
<p>In this case, the next metadata pair belongs to the current directory. Note that because directories in littlefs are sorted alphabetically, the next metadata pair should only contain filenames greater than any filename in the current pair. </p><hr/>
 <h4><code>0x7xx</code> LFS_TYPE_GSTATE</h4>
<p>Provides delta bits for global state entries.</p>
<p>littlefs has a concept of "global state". This is a small set of state that can be updated by a commit to <em>any</em> metadata pair in the filesystem.</p>
<p>The way this works is that the global state is stored as a set of deltas distributed across the filesystem such that the global state can be found by the xor-sum of these deltas.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; .--------.  .--------.  .--------.  .--------.  .--------.</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;.|        |-&gt;| gdelta |-&gt;|        |-&gt;| gdelta |-&gt;| gdelta |</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;||        | || 0x23   | ||        | || 0xff   | || 0xce   |</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;||        | ||        | ||        | ||        | ||        |</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;|&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39; |&#39;--------&#39;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;&#39;--------&#39;  &#39;----|---&#39;  &#39;--------&#39;  &#39;----|---&#39;  &#39;----|---&#39;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;                 v                       v           v</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;       0x00 --&gt; xor ------------------&gt; xor ------&gt; xor --&gt; gstate = 0x12</div></div><!-- fragment --><p>Note that storing globals this way is very expensive in terms of storage usage, so any global state should be kept very small.</p>
<p>The size and format of each piece of global state depends on the type, which is stored in the chunk field. Currently, the only global state is move state, which is outlined below. </p><hr/>
 <h4><code>0x7ff</code> LFS_TYPE_MOVESTATE</h4>
<p>Provides delta bits for the global move state.</p>
<p>The move state in littlefs is used to store info about operations that could cause to filesystem to go out of sync if the power is lost. The operations where this could occur is moves of files between metadata pairs and any operation that changes metadata pairs on the threaded linked-list.</p>
<p>In the case of moves, the move state contains a tag + metadata pair describing the source of the ongoing move. If this tag is non-zero, that means that power was lost during a move, and the file exists in two different locations. If this happens, the source of the move should be considered deleted, and the move should be completed (the source should be deleted) before any other write operations to the filesystem.</p>
<p>In the case of operations to the threaded linked-list, a single "sync" bit is used to indicate that a modification is ongoing. If this sync flag is set, the threaded linked-list will need to be checked for errors before it can be used reliably. The exact cases to check for are described above in the tail tag.</p>
<p>Layout of the move state:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                                    data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|--      32      --|--      32      --]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1|- 11 -| 10 | 10 ][1|- 11 -| 10 | 10 |---              64               ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^    ^     ^    ^   ^    ^     ^    ^- padding (0)       ^- metadata pair</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |    |     |    |   |    |     &#39;------ move id</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |    |     |    |   |    &#39;------------ move type</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |    |     |    |   &#39;----------------- sync bit</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; |    |     |    |</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160; |    |     |    &#39;- size (12)</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160; |    |     &#39;------ id (0x3ff)</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160; |    &#39;------------ type (0x7ff)</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>Move state fields:</p>
<ol type="1">
<li><b>Sync bit (1-bit)</b> - Indicates if the metadata pair threaded linked-list is in-sync. If set, the threaded linked-list should be checked for errors.</li>
<li><b>Move type (11-bits)</b> - Type of move being performed. Must be either <code>0x000</code>, indicating no move, or <code>0x4ff</code> indicating the source file should be deleted.</li>
<li><b>Move id (10-bits)</b> - The file id being moved.</li>
<li><b>Metadata pair (8-bytes)</b> - Pointer to the metadata-pair containing the move. <hr/>
 <h4><code>0x5xx</code> LFS_TYPE_CRC</h4>
</li>
</ol>
<p>Last but not least, the CRC tag marks the end of a commit and provides a checksum for any commits to the metadata block.</p>
<p>The first 32-bits of the data contain a CRC-32 with a polynomial of <code>0x04c11db7</code> initialized with <code>0xffffffff</code>. This CRC provides a checksum for all metadata since the previous CRC tag, including the CRC tag itself. For the first commit, this includes the revision count for the metadata block.</p>
<p>However, the size of the data is not limited to 32-bits. The data field may larger to pad the commit to the next program-aligned boundary.</p>
<p>In addition, the CRC tag's chunk field contains a set of flags which can change the behaviour of commits. Currently the only flag in use is the lowest bit, which determines the expected state of the valid bit for any following tags. This is used to guarantee that unwritten storage in a metadata block will be detected as invalid.</p>
<p>Layout of the CRC tag:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;        tag                                    data</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;[--      32      --][--      32      --|---        variable length        ---]</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;[1| 3| 8 | 10 | 10 ][--      32      --|---        (size * 8 - 32)        ---]</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; ^  ^  ^    ^    ^            ^- crc                             ^- padding</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160; |  |  |    |    &#39;- size</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; |  |  |    &#39;------ id (0x3ff)</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; |  |  &#39;----------- valid state</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160; |  &#39;-------------- type1 (0x5)</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160; &#39;----------------- valid bit</div></div><!-- fragment --><p>CRC fields:</p>
<ol type="1">
<li><b>Valid state (1-bit)</b> - Indicates the expected value of the valid bit for any tags in the next commit.</li>
<li><b>CRC (32-bits)</b> - CRC-32 with a polynomial of <code>0x04c11db7</code> initialized with <code>0xffffffff</code>.</li>
<li><b>Padding</b> - Padding to the next program-aligned boundary. No guarantees are made about the contents. <hr/>
 </li>
</ol>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
