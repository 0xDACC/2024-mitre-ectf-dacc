<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Deeptrust for PCI security architecture: PIN handling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="maxim-logo-202.gif"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Deeptrust for PCI security architecture
   &#160;<span id="projectnumber">SPEC98T17 rev E</span>
   </div>
   <div id="projectbrief">Specification of Deeptrust, the Security Architecture for Cortex-M.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__pcibx___p_i_n.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">List of functions</a>  </div>
  <div class="headertitle">
<div class="title">PIN handling<div class="ingroups"><a class="el" href="group__pcibx.html">PCI Security Services, Security functions dedicated to PCI PTS POI security</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
List of functions</h2></td></tr>
<tr class="memitem:ga856d7d243dc0508bf0c9707b82c1f32a"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pcibx___p_i_n.html#ga856d7d243dc0508bf0c9707b82c1f32a">pci_authenticate_issuer_and_icc_public_key</a> (unsigned char *issuer_certificate, int issuer_certificate_len, unsigned char *issuer_remainder, int issuer_remainder_len, unsigned char *issuer_exponent, int issuer_exponent_len, unsigned char *icc_certificate, int icc_certificate_len, unsigned char *icc_remainder, int icc_remainder_len, unsigned char *icc_exponent, int icc_exponent_len, <a class="el" href="struct_certification_authorities.html">CertificationAuthorities</a> *CA_key)</td></tr>
<tr class="memdesc:ga856d7d243dc0508bf0c9707b82c1f32a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Authenticates both issuer public key and ICC public key.  <a href="#ga856d7d243dc0508bf0c9707b82c1f32a">More...</a><br /></td></tr>
<tr class="separator:ga856d7d243dc0508bf0c9707b82c1f32a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga37d6e36be9921cb568f707b7afd25391"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pcibx___p_i_n.html#ga37d6e36be9921cb568f707b7afd25391">pci_get_online_pin</a> (unsigned char pan[], int pan_len, unsigned char encrypted_pin[], int *encrypted_pin_len)</td></tr>
<tr class="memdesc:ga37d6e36be9921cb568f707b7afd25391"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets the "online" PIN, i.e. encrypted with the DUKPT algorithm. The resulting encrypted PIN block is encoded into ISO 9564 Format 0.  <a href="#ga37d6e36be9921cb568f707b7afd25391">More...</a><br /></td></tr>
<tr class="separator:ga37d6e36be9921cb568f707b7afd25391"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4404aa0dfb0b243b0bb616ad90fc36ca"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pcibx___p_i_n.html#ga4404aa0dfb0b243b0bb616ad90fc36ca">pci_pin_entry</a> (int timeout_entry, int entry_device, int display_device)</td></tr>
<tr class="memdesc:ga4404aa0dfb0b243b0bb616ad90fc36ca"><td class="mdescLeft">&#160;</td><td class="mdescRight">Displays a message to the user instructing to enter the PIN. Then gets the pin from the specified entry device.  <a href="#ga4404aa0dfb0b243b0bb616ad90fc36ca">More...</a><br /></td></tr>
<tr class="separator:ga4404aa0dfb0b243b0bb616ad90fc36ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5863c0668309f185c444d3e8cc6fc05c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__pcibx___p_i_n.html#ga5863c0668309f185c444d3e8cc6fc05c">pci_verify_offline_pin</a> (unsigned char challenge[], int challenge_len, int encrypt_mode, unsigned int timeout)</td></tr>
<tr class="memdesc:ga5863c0668309f185c444d3e8cc6fc05c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Verifies user PIN using the Smart Card.  <a href="#ga5863c0668309f185c444d3e8cc6fc05c">More...</a><br /></td></tr>
<tr class="separator:ga5863c0668309f185c444d3e8cc6fc05c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>This module is in charge of handling PIN entry and processing according to the applicable PCT-PTS-POI standard. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga856d7d243dc0508bf0c9707b82c1f32a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga856d7d243dc0508bf0c9707b82c1f32a">&sect;&nbsp;</a></span>pci_authenticate_issuer_and_icc_public_key()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pci_authenticate_issuer_and_icc_public_key </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>issuer_certificate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>issuer_certificate_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>issuer_remainder</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>issuer_remainder_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>issuer_exponent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>issuer_exponent_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>icc_certificate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>icc_certificate_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>icc_remainder</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>icc_remainder_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>icc_exponent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>icc_exponent_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="struct_certification_authorities.html">CertificationAuthorities</a> *&#160;</td>
          <td class="paramname"><em>CA_key</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Authenticates both issuer public key and ICC public key. </p>
<p>This function authenticates both issuer public key and ICC public key by a hardcoded Certification Authority Public key.</p>
<p>As per EMV Book2, ICC can use either ICC Public Key or ICC PIN Encipherment Key for Offline Pin Authentication.</p>
<p>EMV Application kernel Identifies which ICC Public key to be used for Offline PIN Encipherment. But, SHIDDaemon uses ICC key only after Successful Authentication. Since CA key is hard coded inside SHIDDaemon, Security is not compromised even when Application kernel provides part of keys and certificate as input to SHIDDaemon.</p>
<p>After use, the PIN buffered gets zeroed using memset.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">issuer_certificate</td><td>Issuer Public key certificate </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">issuer_certificate_len</td><td>Issuer Public key certificate length </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">icc_certificate</td><td>ICC Public key certificate </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">icc_certificate_len</td><td>ICC Public key certificate length</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error code </dd></dl>

</div>
</div>
<a id="ga37d6e36be9921cb568f707b7afd25391"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga37d6e36be9921cb568f707b7afd25391">&sect;&nbsp;</a></span>pci_get_online_pin()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pci_get_online_pin </td>
          <td>(</td>
          <td class="paramtype">unsigned char&#160;</td>
          <td class="paramname"><em>pan</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>pan_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char&#160;</td>
          <td class="paramname"><em>encrypted_pin</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&#160;</td>
          <td class="paramname"><em>encrypted_pin_len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets the "online" PIN, i.e. encrypted with the DUKPT algorithm. The resulting encrypted PIN block is encoded into ISO 9564 Format 0. </p>
<p>It uses the PIN buffered using pci_pin_entry.</p>
<p>The context is checked so that only the right caller that has started the PIN entry process can call this function.</p>
<p>After use, the PIN buffered gets zeroed using memset, as well as DUKPT temporary buffers</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">store_id</td><td>The DUKPT store identifier </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">PIN</td><td>The clear-text PIN </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">PAN</td><td>The PAN </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PAN_len</td><td>The PAN length</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>See error codes </dd></dl>

</div>
</div>
<a id="ga4404aa0dfb0b243b0bb616ad90fc36ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4404aa0dfb0b243b0bb616ad90fc36ca">&sect;&nbsp;</a></span>pci_pin_entry()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pci_pin_entry </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>timeout_entry</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>entry_device</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>display_device</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Displays a message to the user instructing to enter the PIN. Then gets the pin from the specified entry device. </p>
<p>The PIN must be entered before a certain amount of time. If not, the function returns.</p>
<p>In case of error, no PIN data remains anywhere in memory. In case of success, the PIN data is kept during at most timeout_pin</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">timeout_entry</td><td>The timeout for the entry of the PIN by the user </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">timeout_pin</td><td>The maximum time during which the PIN is kept in memory. Otherwise it gets zeroed using memset. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">entry_device</td><td>The entry device </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">display_device</td><td>The display device</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>See error codes </dd></dl>

</div>
</div>
<a id="ga5863c0668309f185c444d3e8cc6fc05c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5863c0668309f185c444d3e8cc6fc05c">&sect;&nbsp;</a></span>pci_verify_offline_pin()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int pci_verify_offline_pin </td>
          <td>(</td>
          <td class="paramtype">unsigned char&#160;</td>
          <td class="paramname"><em>challenge</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>challenge_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>encrypt_mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>timeout</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Verifies user PIN using the Smart Card. </p>
<p>This function verifies encrypted pin block with ICC. This function receives Verify APDU header and embedded encrypted pin block before sending it to ICC.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">Verify_APDU_Res</td><td>APDU response </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">Verify_APDU_Res_len</td><td>The verify apdu resource length </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">timeout</td><td>Maximum time allowed for APDU transaction. This value should be in Seconds. </td></tr>
    <tr><td class="paramdir"></td><td class="paramname">Verify_APDU_Req</td><td>The verify apdu request </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">Verify_APDU_len</td><td>APDU response length</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error code </dd></dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="site-footer" align="center">
<div id="site-footer-edge1"></div>
<!-- BEGIN: FOOTER CONTROL PANEL -->
<div id="fcp-shell">
<table id="fcp-table1" border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr valign="middle">
    <td id="fcp-box1" align="left" width="97%">
    <div class="fcp-text"><nobr>© 2017 Maxim Integrated</nobr></div>
    </td>
    <td id="fcp-box2" align="right" width="1%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
    <td id="fcp-box3" align="right" width="1%">
    <div class="fcp-text"><nobr>
    <a class="fcp" href="http://www.maximintegrated.com/contact/">Contact Us</a>
    &nbsp;&nbsp; | &nbsp;&nbsp;
    <a class="fcp" href="http://www.maximintegrated.com/legal/privacy.cfm">Privacy Policy</a>
    &nbsp;&nbsp; | &nbsp;&nbsp;
    <a class="fcp" href="http://www.maximintegrated.com/legal/">Legal Notices</a>
    &nbsp;&nbsp; | &nbsp;&nbsp;
    </nobr></div>
    </td>
</tr>
</tbody></table>
</div><!-- /fcp-shell -->
<!-- END: FOOTER CONTROL PANEL -->
<div id="site-footer-edge2"></div>
</div>
